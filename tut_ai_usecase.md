---

copyright:
  years: 2022, 2024
lastupdated: "2024-04-30"

keywords: provisioning, query, engine, watsonx.ai

subcollection: watsonxdata

content-type: tutorial
account-plan: paid
completion-time: 0.5h

---

{{site.data.keyword.attribute-definition-list}}


{:step: data-tutorial-type="step"}
{:shortdesc: .shortdesc}


# Integrating watsonx.ai with watsonx.data for retrieval-augmented generation (RAG)
{: #tutorial_rag}
{: toc-content-type="tutorial"}
{: toc-completion-time="0.5h"}


This tutorial guides you through a cross-platform integration of IBM watsonx.ai and IBM watsonx.data to achieve a use case to demonstrate how RAG can be applied to generate informative responses to user queries based on a given knowledge base. It uses relevant information from an external knowledge base (here, Wikipedia). For more information about RAG, see [Retrieval-augmented generation (RAG)](https://dataplatform.cloud.ibm.com/docs/content/wsj/analyze-data/fm-rag.html?context=wx&audience=wdp).
{: shortdesc}

The embedded Milvus vector database in watsonx.data allows you to prepare, store, query, and deliver data to the generative AI solution of watsonx.ai for LLM response generation.
<!-- enhance responses generated by large language models (LLM) -->

<!-- **Sample Scenario** : Team of data engineers and data scientists are working on creating a vector database for a sample data set to feed LLM. Also analyze historical climate change data to derive insights for accurate forecasts and make data-driven decisions. -->



## Objective
{: #rag_obj}

<!-- Consider a sample data set from Wikipedia. Split the content into manageable subsets. Create vector embeddings with the sample data and insert them into the Milvus vector database. Use watsonx.ai to query Milvus with various questions, embed them into the LLM context and prompt the LLM to generate a useful response. -->

1. Creating a project in watsonx.ai.
2. Collecting sample data (here, from Wikipedia) and other web articles into a Jupyter Notebook.
3. Vectorizing the sample data in watsonx.data and inserting it into the Milvus vector database.
4. Feeding the vector data generated by Milvus into a large language model present in watsonx.ai to generate a response to a question.



## Before you begin
{: #rag_byb}

This tutorial requires a trial account (or a paid account) on the [IBM Cloud](https://cloud.ibm.com/login).


## Setting up the environment
{: #rag_stp1}
{: step}

In this section, learn to set up watsonx.data and watsonx.ai for running RAG use cases.
{: shortdesc}


1. Setup a watsonx.data instance

   1. Go to [{{site.data.keyword.lakehouse_short}} IBM Cloud catalog](https://cloud.ibm.com/watsonxdata) page.
   1. Provision a {{site.data.keyword.lakehouse_short}} service Lite plan instance. For more information, see [watsonx.data Lite plan](watsonxdata?topic=watsonxdata-tutorial_hp_intro).
   2. Provision a Presto engine. For more information, see [Provisioning a Presto engine](watsonxdata?topic=watsonxdata-prov_engine).
   2. Create a Milvus service. For more information, see [Adding Milvus service](watsonxdata?topic=watsonxdata-adding-milvus-service).

2. Setup a watsonx.ai instance

   1. Go to [watsonx.ai](https://eu-de.dataplatform.cloud.ibm.com/registration/stepone?context=wx&preselect_region=true).
   1. Follow the on-screen instructions and provision a watsonx.ai trial instance.
   2. Create a new project. For more information, see [Creating a project](https://dataplatform.cloud.ibm.com/docs/content/wsj/getting-started/projects.html?context=wx&audience=wdp).

   Make sure that you provision the Cloud Object Storage in the same namespace where you provision the watsonx.ai instance.
   {: note}

3. Configure the parameter details and save the Environment file as `config.env`. For more information about retrieving the parameter values, see [Parameter values](watsonxdata?topic=watsonxdata-ret_credentials).

4. Download and save the `Load to Milvus for RAG.ipynb` file to your computer.

5. Upload the Environment file (`config.env`) and the Jupyter Notebook (`Load to Milvus for RAG.ipynb`) to the watsonx.ai project.

   1. Log in to your [IBM watsonx.ai](https://cloud.ibm.com/login?state=https%3A%2F%2Fdataplatform.cloud.ibm.com%2Fregistration%2Fsteptwo%2F%3Fcontext%3Dwx%26apps%3Ddata_science_experience%2Cwatson_machine_learning%2Ccos%2Caiopenscale%26new_user%3Dtrue%26uucid%3D0b526de8c1c419db%26utm_content%3DWXAWW%26content_campaign_code%3DWXAWW) instance.
   2. Select the project and click the **Assets** tab.
   3. Upload the Jupyter Notebook (`Load to Milvus for RAG.ipynb`). To upload:

       a. Click **New asset** and select **Work with data and models in Python or R notebooks**.
       b. Enter a name and description for the Jupyter Notebook file.
       c. From the left pane, select **Local File**. Drag and drop or upload the Jupyter Notebook.
       d. Click **Create**. The notebook is uploaded to the project.

   3. Upload the `config.env` file. To do that:
       a. Click **Upload asset to project** icon.
       b. Drag and drop or upload the `config.env` file.

## Running Jupyter Notebook
{: #rag_stp2}
{: step}

### Overview
{: #rag_stp2_ovrw}

The Jupyter Notebook includes Python scripts to perform the following functions:
* Exploring sample data
* Breaking down data into chunks
* Vectorizing the data chunks
* Prompting and response generation

You can step through the notebook execution cell by cell. Select the cell and press **Shift**+**Enter**. \n
You can also run the entire Jupyter Notebook by clicking **Run All** from the navigation menu. For more information, see [Coding and running a notebook](https://dataplatform.cloud.ibm.com/docs/content/wsj/analyze-data/code-run-notebooks.html?context=wx&audience=wdp).


### Run the Jupyter Notebook
{: #rag_run_nb}

1. Log in to your IBM watsonx.ai instance.
2. Select the project and click the **Assets** tab.
3. Go to **Asset types** > **Notebooks** and select `Load to Milvus for RAG.ipynb`. The `Load to Milvus for RAG.ipynb` notebook page opens.
3. Click the Edit icon to start editing the notebook. For more information, see [Running a notebook](https://dataplatform.cloud.ibm.com/docs/content/wsj/analyze-data/code-run-notebooks.html?context=wx&audience=wdp).


The Jupyter Notebook includes the following sections. You can run the Python scripts cell by cell to achieve the use case.


   a. Install libraries
   : Install the required libraries for running the Python notebook. You can run this cell to install the `pymilvus` package to the watsonx.ai Python environment.

b. Restart the kernel
: Restart the kernel after you install the dependencies.

c. Create environment variables
: Provide the following parameter values and run the cell.
   * <INSERT_PROJECT_TOKEN>
   * <INSERT_PROJECT_ID>
   * <ibm_cloud_url>
   * <api_key>

   For more information about retrieving the parameter values, see [Parameter values](watsonxdata?topic=watsonxdata-ret_credentials).

d. Wikipedia exploration
: In this use case, the sample data from Wikipedia is considered. Here, you can search for a particular article from Wikipedia and fetch the article. Specify the following parameter values and run the cell.

   * <PICK_A_TOPIC>: Topic name that you want to consider from the use case.
   * <INSERT_WIKIPEDIA_TITLE> : Title for the article.

e. Split Wikipedia data into chunks
: Split the data into smaller chunks (in this use case, the considered size is 255) for analysis and assign titles for each chunk of data. Assemble the article text and article title into a data object and load the data into Milvus for vectorization.

f. Load data to Milvus and vectorize
: Use a sentence transformer model (in this use case, `sentence-transformers/all-MiniLM-L6-v2`) to vectorize the data chunks. Define a collection and store the vectorized data into the collection. Run the following steps:
   1 Provide the following parameters and run the cell to establish connection with Milvus.
      * `<MILVUS_HOST>`: The Milvus hostname.
      * `<MILVUS_PORT>`: The Milvus port number.
      * `<MILVUS_PASSWORD>`: The IBM Cloud API key.

      For more information on the parameter values, see [Parameter values](watsonxdata?topic=watsonxdata-ret_credentials).

   1 After you establish connection with Milvus, create a collection (specify the name in <NAME_OF_COLLECTION>) to store the vectorized data. You can run `utility.list_collections()` to verify the creation of the collection.
   1 Load the data to Milvus and start vectorization.

g. Prompting and response generation
: Establish a connection with Milvus, load the collection, and execute query function. Provide your query as the `<INSERT_QUESTION_TO_ASK_LLM>` parameter value and run the cells sequentially. The `print(prompt)` displays the result.
You can also prompt from the watsonx.ai interface. For more information, see [Querying from watsonx.ai prompts](#rag_prmt).


## Querying from watsonx.ai prompts
{: #rag_prmt}
{: step}

1. Log in to your IBM watsonx.ai instance.
1. Click the **Open Prompt Lab** link. The prompt lab opens.
1. In the **Input** field, provide your query that is related to the sample data that you consider for analysis (in this use case, an article from Wikipedia).
1. In the **Output** field, you can see the result.
