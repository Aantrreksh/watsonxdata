---

copyright:
  years: 2022, 2024
lastupdated: "2024-07-03"

keywords: provisioning, query, engine, watsonx.ai

subcollection: watsonxdata

content-type: tutorial
account-plan: paid
completion-time: 0.5h

---

{{site.data.keyword.attribute-definition-list}}


{:step: data-tutorial-type="step"}
{:shortdesc: .shortdesc}


# Integrating watsonx.ai with watsonx.data for retrieval-augmented generation (RAG)
{: #tutorial_rag}
{: toc-content-type="tutorial"}
{: toc-completion-time="0.5h"}


This tutorial guides you through a cross-platform integration of watsonx.ai and watsonx.data to achieve a use case to demonstrate how RAG can be applied to generate informative responses to user queries based on a given knowledge base. It uses relevant information from an external knowledge base (here, Wikipedia). For more information about RAG, see [Retrieval-augmented generation (RAG)](https://dataplatform.cloud.ibm.com/docs/content/wsj/analyze-data/fm-rag.html?context=wx&audience=wdp).
{: shortdesc}

The embedded Milvus vector database in watsonx.data allows you to prepare, store, query, and deliver data to the generative AI solution of watsonx.ai for LLM response generation.
<!-- enhance responses generated by large language models (LLM) -->

<!-- **Sample Scenario** : Team of data engineers and data scientists are working on creating a vector database for a sample data set to feed LLM. Also analyze historical climate change data to derive insights for accurate forecasts and make data-driven decisions. -->



## Objective
{: #rag_obj}

<!-- Consider a sample data set from Wikipedia. Split the content into manageable subsets. Create vector embeddings with the sample data and insert them into the Milvus vector database. Use watsonx.ai to query Milvus with various questions, embed them into the LLM context and prompt the LLM to generate a useful response. -->

1. Creating a project in watsonx.ai.
2. Associating a machine learning service with your project.
2. Connecting to Milvus data source.
2. Collecting sample data (here, from Wikipedia) and other web articles into a Jupyter Notebook.
3. Inserting it into the Milvus vector database for vectorizing.
4. Feeding the vector data generated by Milvus into a large language model present in watsonx.ai to generate a response to a question.



## Before you begin
{: #rag_byb}

This tutorial requires a trial account (or a paid account) on [IBM Cloud](https://cloud.ibm.com/login).


## Setting up the environment
{: #rag_stp1}
{: step}

In this section, learn to set up watsonx.data and watsonx.ai to run RAG use cases.
{: shortdesc}


1. Set up a watsonx.data instance.

   1. Go to [{{site.data.keyword.lakehouse_short}} IBM Cloud catalog](https://cloud.ibm.com/watsonxdata) page.
   1. Provision a {{site.data.keyword.lakehouse_short}} service Lite plan instance. For more information, see [watsonx.data Lite plan](watsonxdata?topic=watsonxdata-tutorial_hp_intro).
   2. Provision a Presto (Java) engine. For more information, see [Provisioning a Presto (Java) engine](watsonxdata?topic=watsonxdata-prov_engine).
   2. Create a Milvus service. For more information, see [Adding Milvus service](watsonxdata?topic=watsonxdata-adding-milvus-service).

2. Set up a watsonx.ai instance.

   1. Go to [watsonx.ai](https://eu-de.dataplatform.cloud.ibm.com/registration/stepone?context=wx&preselect_region=true).
   1. Follow the on-screen instructions and provision a watsonx.ai trial instance.
   2. Create a new project. For more information, see [Creating a project](https://dataplatform.cloud.ibm.com/docs/content/wsj/getting-started/projects.html?context=wx&audience=wdp).

   You can also use an existing project.

   Make sure that you provision the Cloud Object Storage in the same namespace where you provision the watsonx.ai instance.
   {: note}

## Choosing machine learning service
{: #rag_stp2}
{: step}

3. From the watsonx.ai project, select the **Manage** tab.
4. From the left navigation pane, select **Access control**. Click the **Access token** tab and click **New access token**.
4. In the **New access token** window, specify name and choose **Editor** role and click **Create**. The access token is generated and a success message is displayed.
4. From the left navigation pane, select **Services & integrations**.
5. Click **Associate service**. In the **Associate service** page, click **New service +**. The **Services** page opens.

If your watsonx.ai project already includes a Watson Machine Learning service, no need to associate a new service.
{: note}

6. Select **Watson Machine Learning**. Click **Create**.
7. Choose the machine learning service from the  **Associate service** page to associate to your project and click **Associate**.


## Creating connection asset to Milvus data source
{: #rag_stp3}
{: step}

5. Click **Assets** tab from your wastonx.ai project. Click **New asset**.
6. In the **What do you want to do?** page, select **Connect to a data source**.
7. From the **Connect to a data source** page, choose **Milvus** and click **Select**. The **Connect to a data source: Milvus** page opens.
8. Specify the following connection details.
    * `Name`: Provide a name for the connection. Recommended name is `Milvus connection` as it is used throughout the tutorial.
    * `Hostname`: The host name of the Milvus service. For more information on how to retrieve the hostname, see `MILVUS_HOST` in [Retrieving parameter values](watsonxdata?topic=watsonxdata-ret_credentials).
    * `Port`: The port number of the Milvus service. For more information on how to retrieve the port number, see `MILVUS_PORT` in [Retrieving parameter values](watsonxdata?topic=watsonxdata-ret_credentials).
    * `Username` : For more information on how to retrieve the username, see `MILVUS_USER` in [Retrieving parameter values](watsonxdata?topic=watsonxdata-ret_credentials).
    * `Password` : The password is the IBM Cloud API_KEY. For more information on how to retrieve the password, see `MILVUS_PASSWORD` in [Retrieving parameter values](watsonxdata?topic=watsonxdata-ret_credentials).

9. Disable the field **Port is SSL-enabled**.

9. Click the **Test connection** button on the upper right corner to make sure the connection works. If your test is successful, `The test was successful` message is displayed.

9. Click **Create**. In the **Assets** tab, a new connection is displayed.

## Uploading the Jupyter Notebook
{: #rag_stp4}
{: step}

1. Log in to your [watsonx.ai](https://cloud.ibm.com/login?state=https%3A%2F%2Fdataplatform.cloud.ibm.com%2Fregistration%2Fsteptwo%2F%3Fcontext%3Dwx%26apps%3Ddata_science_experience%2Cwatson_machine_learning%2Ccos%2Caiopenscale%26new_user%3Dtrue%26uucid%3D0b526de8c1c419db%26utm_content%3DWXAWW%26content_campaign_code%3DWXAWW) instance.
2. Select the project and click the **Assets** tab.
3. Add the Jupyter Notebook (`watsonx.data RAG Notebook`). To add:

   a. Click **New asset** and select **Work with data and models in Python or R notebooks**.

   b. Enter a name (here, 'watsonx.data RAG Notebook') and description for the Jupyter Notebook file.

   c. From the left pane, select **URL**. In the **Notebook URL** field, paste the watsonx.data RAG Notebook URL :
   `https://raw.githubusercontent.com/IBM/watsonx-data/main/Tutorials/watsonxdata-RAG-tutorial.ipynb`
   .

   d. Click **Create**. The notebook is uploaded to the project.



## Running Jupyter Notebook
{: #rag_stp5}
{: step}

### Overview
{: #rag_stp2_ovrw}

The Jupyter Notebook includes Python scripts to perform the following functions:
* Exploring sample data
* Breaking down data into chunks
* Vectorizing the data chunks
* Prompting and response generation

You can step through the notebook and execute the Python scripts cell by cell. Select the cell and press **Shift**+**Enter**.

You can also run the entire Jupyter Notebook by clicking **Run All** from the navigation menu. For more information, see [Coding and running a notebook](https://dataplatform.cloud.ibm.com/docs/content/wsj/analyze-data/code-run-notebooks.html?context=wx&audience=wdp).


### Run the Jupyter Notebook
{: #rag_run_nb}

1. From the watsonx.ai project, click the **Assets** tab.
3. Go to **Asset types** > **Notebooks** and select `watsonx.data RAG Notebook.ipynb`. The `watsonx.data RAG Notebook.ipynb` notebook page opens.
3. Click the **Edit** icon to start editing the notebook. For more information, see [Running a notebook](https://dataplatform.cloud.ibm.com/docs/content/wsj/analyze-data/code-run-notebooks.html?context=wx&audience=wdp).

4. Insert a project token to start. Click the **Insert project token** icon at the top right corner of the page. It generates the project token cell. Token needs to be generated only once. After generating the token, move the Token cell downwards and place it after the cell, **RESTART THE KERNAL AFTER pymilvus install** (use down arrow from the top pane and move it seven times downwards).

The Jupyter Notebook includes the following sections. You can run the Python scripts cell by cell to achieve the use case.


a. Install libraries
: Install the required libraries for running the Python notebook. You can run this cell to install the `pymilvus` package to the watsonx.ai Python environment.

b. Restart the kernel
: Restart the kernel after you install the dependencies. This is a one-time process.
<!--
c. Create environment variables
: Provide the following parameter values and run the cell.
   * <INSERT_PROJECT_TOKEN>
   * <INSERT_PROJECT_ID>
   * <ibm_cloud_url>
   * <api_key>

   For more information about retrieving the parameter values, see [Parameter values](watsonxdata?topic=watsonxdata-ret_credentials). -->

c. Wikipedia exploration
: In this use case, the sample data from Wikipedia is considered. Here, `Climate change`. You can search for other articles also from Wikipedia. Specify the following parameter values and run the cell.

   * <PICK_A_TOPIC>: Topic name that you want to consider from the use case.
   * <INSERT_WIKIPEDIA_TITLE> : Title for the article.

d. Split Wikipedia data into chunks
: Here, connection to Milvus is established.

   i. After you establish connection with Milvus, create a collection (specify the name in <NAME_OF_COLLECTION>) to store the vectorized data. You can run `utility.list_collections()` to verify the creation of the collection.

   ii. Load the data to Milvus and start vectorization.

    The data is split into smaller chunks (in this use case, the considered size is 255) to analyze and assign a title to each chunk of data. Assemble the article text and article title into a data object and load the data into Milvus for vectorization.

e. Load data to Milvus and vectorize
: Use a sentence transformer model (in this use case, `sentence-transformers/all-minilm-l12-v2`) to vectorize the data chunks. Define a collection and store the vectorized data into the collection.

<!-- Run the following steps:

   1 Provide the following parameters and run the cell to establish connection with Milvus.
      * `<MILVUS_HOST>`: The Milvus hostname.
      * `<MILVUS_PORT>`: The Milvus port number.
      * `<MILVUS_PASSWORD>`: The IBM Cloud API key.

   For more information on the parameter values, see [Parameter values](watsonxdata?topic=watsonxdata-ret_credentials). -->



f. Prompting and response generation
: Establish a connection with Milvus, load the collection, and execute query function. Provide your query as the `<INSERT_QUESTION_TO_ASK_LLM>` parameter value and run the cells sequentially. The `print(prompt)` displays the result.

<!-- You can also prompt from the watsonx.ai interface. For more information, see [Querying from watsonx.ai prompts](#rag_prmt).


## Querying from watsonx.ai prompts
{: #rag_prmt}
{: step}

1. Log in to your watsonx.ai instance.
1. Click the **Open Prompt Lab** link. The prompt lab opens.
1. In the **Input** field, provide your query that is related to the sample data that you consider for analysis (in this use case, an article from Wikipedia).
1. In the **Output** field, you can see the result.

For more information, see [Prompt Lab](https://dataplatform.cloud.ibm.com/docs/content/wsj/analyze-data/fm-prompt-lab.html?context=wx&audience=wdp). -->
